// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============ USERS & AUTHENTICATION ============

model User {
  id                  Int      @id @default(autoincrement())
  username            String   @unique
  email               String   @unique
  password            String
  firstName           String?
  lastName            String?
  avatar              String?
  phone               String?
  active              Boolean  @default(true)
  twoFactorEnabled    Boolean  @default(false)
  groupId             Int
  group               UserGroup @relation(fields: [groupId], references: [id])
  
  // New fields
  lastLogin           DateTime?
  lastIp              String?
  preferences         Json?
  apiToken            String?   @unique
  lastActivityAt      DateTime?
  
  // Relations
  sales               Sale[]
  purchases           Purchase[]
  payments            Payment[]
  registers           CashRegister[]
  expenses            Expense[]
  auditLogs           AuditLog[]
  notificationsSent   Notification[]
  loginAttempts       LoginAttempt[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("tec_users")
}

model UserGroup {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]
  permissions Permission[]

  @@map("tec_groups")
}

model Permission {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  description String?
  groupId   Int
  group     UserGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@map("permissions")
}

model ApiToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())

  @@map("api_tokens")
}

model LoginAttempt {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String
  success   Boolean
  timestamp DateTime  @default(now())

  @@map("tec_login_attempts")
}

// ============ PRODUCTS & INVENTORY ============

model Category {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  name      String
  image     String?   @default("no_image.png")
  active    Boolean   @default(true)
  products  Product[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("tec_categories")
}

model Product {
  id                  Int       @id @default(autoincrement())
  code                String    @unique
  name                String
  categoryId          Int
  category            Category  @relation(fields: [categoryId], references: [id])
  price               Decimal   @db.Decimal(25, 2)
  cost                Decimal?  @db.Decimal(25, 2)
  quantity            Decimal   @default(0) @db.Decimal(15, 2)
  alertQuantity       Decimal   @default(0) @db.Decimal(10, 2)
  
  // Tax fields
  tax                 Decimal?  @db.Decimal(10, 2)
  taxMethod           Int       @default(1) // 1: included, 0: excluded
  taxCategory         String?
  
  // Barcode & Type
  barcode             String?   @unique
  barcodeSymbology    String    @default("code39")
  type                String    @default("standard") // standard, combo, service
  isComposite         Boolean   @default(false)
  
  // Details
  image               String?   @default("no_image.png")
  details             String?   @db.Text
  supplierCode        String?
  gtin                String?
  
  active              Boolean   @default(true)
  
  // Relations
  saleItems           SaleItem[]
  purchaseItems       PurchaseItem[]
  comboItems          ComboItem[]
  suspendedItems      SuspendedItem[]
  stockMovements      StockMovement[]
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("tec_products")
}

model ComboItem {
  id        Int       @id @default(autoincrement())
  productId Int
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  itemCode  String
  quantity  Decimal   @db.Decimal(12, 4)
  price     Decimal?  @db.Decimal(25, 2)
  cost      Decimal?  @db.Decimal(25, 2)

  @@map("tec_combo_items")
}

model StockMovement {
  id        Int       @id @default(autoincrement())
  productId Int
  product   Product   @relation(fields: [productId], references: [id])
  type      String    // IN, OUT, ADJUSTMENT
  quantity  Decimal   @db.Decimal(15, 2)
  reference String?
  note      String?   @db.Text
  createdAt DateTime  @default(now())

  @@map("stock_movements")
}

// ============ CUSTOMERS & SUPPLIERS ============

model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  email     String?   @unique
  phone     String?
  custom1   String?   // cf1 from legacy
  custom2   String?   // cf2 from legacy
  address   String?
  city      String?
  state     String?
  zipCode   String?
  
  notes     String?   @db.Text
  active    Boolean   @default(true)
  
  // Relations
  sales     Sale[]
  payments  Payment[]
  giftCards GiftCard[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("tec_customers")
}

model Supplier {
  id        Int       @id @default(autoincrement())
  name      String
  email     String?   @unique
  phone     String?
  custom1   String?
  custom2   String?
  address   String?
  
  notes     String?   @db.Text
  active    Boolean   @default(true)
  
  // Relations
  purchases Purchase[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("tec_suppliers")
}

// ============ SALES & PAYMENTS ============

model Sale {
  id                  Int       @id @default(autoincrement())
  date                DateTime
  customerId          Int
  customer            Customer  @relation(fields: [customerId], references: [id])
  customerName        String
  
  // Amounts
  total               Decimal   @db.Decimal(25, 2)
  productDiscount     Decimal?  @default(0) @db.Decimal(25, 2)
  orderDiscount       Decimal?  @default(0) @db.Decimal(25, 2)
  totalDiscount       Decimal?  @default(0) @db.Decimal(25, 2)
  
  // Taxes
  productTax          Decimal?  @default(0) @db.Decimal(25, 2)
  orderTax            Decimal?  @default(0) @db.Decimal(25, 2)
  totalTax            Decimal?  @default(0) @db.Decimal(25, 2)
  
  grandTotal          Decimal   @db.Decimal(25, 2)
  totalItems          Int?
  totalQuantity       Decimal?  @db.Decimal(15, 2)
  paid                Decimal?  @default(0) @db.Decimal(25, 2)
  rounding            Decimal?  @default(0) @db.Decimal(8, 2)
  
  // Status & Details
  status              String    @default("draft") // draft, finalized, paid, cancelled
  note                String?   @db.Text
  receiptNumber       String?   @unique
  fiscalReference     String?
  signedAt            DateTime?
  
  // Tracking
  createdBy           Int
  createdByUser       User      @relation(fields: [createdBy], references: [id])
  updatedBy           Int?
  updatedAt           DateTime  @updatedAt
  auditLogId          Int?
  
  // Relations
  items               SaleItem[]
  payments            Payment[]

  @@map("tec_sales")
}

model SaleItem {
  id              Int       @id @default(autoincrement())
  saleId          Int
  sale            Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product   @relation(fields: [productId], references: [id])
  
  quantity        Decimal   @db.Decimal(15, 2)
  unitPrice       Decimal   @db.Decimal(25, 2)
  netUnitPrice    Decimal   @db.Decimal(25, 2)
  realUnitPrice   Decimal?  @db.Decimal(25, 2)
  
  // Discount
  discount        String?   // percentage or fixed
  itemDiscount    Decimal?  @default(0) @db.Decimal(25, 2)
  
  // Tax
  tax             Decimal?  @db.Decimal(10, 2)
  itemTax         Decimal?  @default(0) @db.Decimal(25, 2)
  
  subtotal        Decimal   @db.Decimal(25, 2)
  cost            Decimal?  @default(0) @db.Decimal(25, 2)

  @@map("tec_sale_items")
}

model Payment {
  id                Int       @id @default(autoincrement())
  date              DateTime  @default(now())
  saleId            Int?
  sale              Sale?     @relation(fields: [saleId], references: [id], onDelete: SetNull)
  customerId        Int?
  customer          Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Payment method
  paidBy            String    // cash, CC, check, gift_card, transfer, etc
  amount            Decimal   @db.Decimal(25, 2)
  
  // CC Details
  ccNo              String?
  ccHolder          String?
  ccMonth           String?
  ccYear            String?
  ccType            String?
  
  // Check Details
  checkNo           String?
  
  // Gift Card
  gcNo              String?
  
  // General
  currency          String?   @default("BRL")
  reference         String?
  transactionId     String?
  note              String?   @db.Text
  attachment        String?
  
  // POS specific
  posPaid           Decimal?  @default(0) @db.Decimal(25, 2)
  posBalance        Decimal?  @default(0) @db.Decimal(25, 2)
  
  // Tracking
  createdBy         Int
  createdByUser     User      @relation(fields: [createdBy], references: [id])
  updatedBy         Int?
  updatedAt         DateTime  @updatedAt

  @@map("tec_payments")
}

model GiftCard {
  id          Int       @id @default(autoincrement())
  cardNo      String    @unique
  value       Decimal   @db.Decimal(25, 2)
  balance     Decimal   @db.Decimal(25, 2)
  customerId  Int?
  customer    Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  expiry      DateTime?
  createdBy   Int?
  active      Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tec_gift_cards")
}

// ============ CASH & REGISTERS ============

model CashRegister {
  id                      Int       @id @default(autoincrement())
  date                    DateTime
  userId                  Int
  user                    User      @relation(fields: [userId], references: [id])
  
  cashInHand              Decimal   @db.Decimal(25, 2)
  status                  String    @default("open") // open, closed
  
  // Closing details
  totalCash               Decimal?  @db.Decimal(25, 2)
  totalCheques            Int?
  totalCcSlips            Int?
  totalCashSubmitted      Decimal?  @db.Decimal(25, 2)
  totalChequesSubmitted   Int?
  totalCcSlipsSubmitted   Int?
  
  note                    String?   @db.Text
  transferOpenedBills     String?
  
  closedAt                DateTime?
  closedBy                Int?
  
  createdAt               DateTime  @default(now())

  @@map("tec_registers")
}

// ============ PURCHASES & INVENTORY ============

model Purchase {
  id          Int       @id @default(autoincrement())
  reference   String    @unique
  date        DateTime  @default(now())
  supplierId  Int?
  supplier    Supplier? @relation(fields: [supplierId], references: [id], onDelete: SetNull)
  
  total       Decimal   @db.Decimal(25, 2)
  note        String?   @db.Text
  attachment  String?
  received    Boolean?  @default(false)
  
  // Tracking
  createdBy   Int
  createdByUser User    @relation(fields: [createdBy], references: [id])
  
  // Relations
  items       PurchaseItem[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tec_purchases")
}

model PurchaseItem {
  id          Int       @id @default(autoincrement())
  purchaseId  Int
  purchase    Purchase  @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product   @relation(fields: [productId], references: [id])
  
  quantity    Decimal   @db.Decimal(15, 2)
  cost        Decimal   @db.Decimal(25, 2)
  subtotal    Decimal   @db.Decimal(25, 2)

  @@map("tec_purchase_items")
}

// ============ EXPENSES ============

model Expense {
  id          Int       @id @default(autoincrement())
  date        DateTime  @default(now())
  reference   String    @unique
  amount      Decimal   @db.Decimal(25, 2)
  note        String?   @db.Text
  attachment  String?
  createdBy   Int
  createdByUser User    @relation(fields: [createdBy], references: [id])
  
  createdAt   DateTime  @default(now())

  @@map("tec_expenses")
}

// ============ SUSPENDED SALES ============

model SuspendedSale {
  id              Int       @id @default(autoincrement())
  date            DateTime
  customerId      Int
  customerName    String
  
  total           Decimal   @db.Decimal(25, 2)
  productDiscount Decimal?  @db.Decimal(25, 2)
  orderDiscount   Decimal?  @db.Decimal(25, 2)
  totalDiscount   Decimal?  @db.Decimal(25, 2)
  
  productTax      Decimal?  @db.Decimal(25, 2)
  orderTax        Decimal?  @db.Decimal(25, 2)
  totalTax        Decimal?  @db.Decimal(25, 2)
  
  grandTotal      Decimal   @db.Decimal(25, 2)
  totalItems      Int?
  totalQuantity   Decimal?  @db.Decimal(15, 2)
  paid            Decimal?  @db.Decimal(25, 2)
  
  note            String?   @db.Text
  holdRef         String?
  createdBy       Int?
  
  items           SuspendedItem[]
  
  createdAt       DateTime  @default(now())

  @@map("tec_suspended_sales")
}

model SuspendedItem {
  id              Int       @id @default(autoincrement())
  suspendId       Int
  suspend         SuspendedSale @relation(fields: [suspendId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product   @relation(fields: [productId], references: [id])
  
  quantity        Decimal   @db.Decimal(15, 2)
  unitPrice       Decimal   @db.Decimal(25, 2)
  netUnitPrice    Decimal   @db.Decimal(25, 2)
  realUnitPrice   Decimal?  @db.Decimal(25, 2)
  
  discount        String?
  itemDiscount    Decimal?  @db.Decimal(25, 2)
  
  tax             Decimal?
  itemTax         Decimal?  @db.Decimal(25, 2)
  
  subtotal        Decimal   @db.Decimal(25, 2)

  @@map("tec_suspended_items")
}

// ============ SETTINGS ============

model Settings {
  id                  Int       @id @default(autoincrement())
  siteName            String    @default("PDVWeb C1")
  logo                String?   @default("logo.png")
  tel                 String?
  email               String?
  
  // Formats
  dateFormat          String    @default("dd/MM/yyyy")
  timeFormat          String    @default("HH:mm:ss")
  timeZone            String    @default("America/Sao_Paulo")
  
  // Currency
  currencyPrefix      String    @default("R$")
  decimals            Int       @default(2)
  thousandsSep        String    @default(",")
  decimalsSep         String    @default(".")
  
  // Defaults
  defaultCustomerId   Int?
  defaultCategoryId   Int?
  defaultTaxRate      String    @default("0%")
  defaultDiscount     String    @default("0%")
  
  // Pagination
  rowsPerPage         Int       @default(25)
  
  // Features
  enableCaptcha       Boolean   @default(true)
  enableStripe        Boolean   @default(false)
  stripeSecretKey     String?
  stripePublishableKey String?
  
  // Printer
  receiptPrinter      String?
  charPerLine         Int       @default(42)
  
  // Display
  language            String    @default("pt-BR")
  theme               String    @default("light")
  displayKeyboard     Boolean   @default(false)
  itemAddition        Boolean   @default(true)
  
  // Headers/Footers
  header              String?   @db.Text
  footer              String?   @db.Text
  
  // System
  version             String    @default("1.0.0")
  maintenanceMode     Boolean   @default(false)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("tec_settings")
}

// ============ AUDIT & LOGGING ============

model AuditLog {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  tableName String
  operation String    // CREATE, UPDATE, DELETE
  
  oldValues Json?
  newValues Json?
  
  ipAddress String?
  userAgent String?
  
  createdAt DateTime  @default(now())

  @@map("audit_logs")
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int?
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String    @db.Text
  type      String    // alert, info, warning, success
  read      Boolean   @default(false)
  readAt    DateTime?
  
  createdAt DateTime  @default(now())

  @@map("notifications")
}

// ============ FINANCIAL MODULE (ERP PLUS) ============

model FinancialCategory {
  id          Int       @id @default(autoincrement())
  name        String
  type        String    // EXPENSE, INCOME
  description String?
  active      Boolean   @default(true)
  
  accountsPayable AccountsPayable[]
  accountsReceivable AccountsReceivable[]
  transactions FinancialTransaction[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("fin_categories")
}

model BankAccount {
  id              Int       @id @default(autoincrement())
  name            String
  bankName        String?
  accountNumber   String?
  agency          String?
  initialBalance  Decimal   @default(0) @db.Decimal(25, 2)
  currentBalance  Decimal   @default(0) @db.Decimal(25, 2)
  active          Boolean   @default(true)
  
  transactions    FinancialTransaction[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("fin_bank_accounts")
}

model Attachment {
  id                  Int       @id @default(autoincrement())
  filename            String
  originalName        String
  mimeType            String
  size                Int
  path                String
  
  // Relations
  accountsPayableId   Int?
  accountsPayable     AccountsPayable? @relation(fields: [accountsPayableId], references: [id], onDelete: Cascade)
  
  accountsReceivableId Int?
  accountsReceivable  AccountsReceivable? @relation(fields: [accountsReceivableId], references: [id], onDelete: Cascade)
  
  paymentId           Int?
  payment             Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  
  transactionId       Int?
  transaction         FinancialTransaction? @relation(fields: [transactionId], references: [id], onDelete: SetNull)

  uploadedBy          Int
  user                User      @relation(fields: [uploadedBy], references: [id])
  
  createdAt           DateTime  @default(now())

  @@map("sys_attachments")
}

model AccountsPayable {
  id              Int       @id @default(autoincrement())
  description     String
  supplierId      Int?
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  
  categoryId      Int?
  category        FinancialCategory? @relation(fields: [categoryId], references: [id])
  
  amount          Decimal   @db.Decimal(25, 2)
  dueDate         DateTime
  paidDate        DateTime?
  
  status          String    @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  paymentMethod   String?
  
  note            String?   @db.Text
  
  // Relations
  installments    Installment[]
  attachments     Attachment[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("fin_accounts_payable")
}

model AccountsReceivable {
  id              Int       @id @default(autoincrement())
  description     String
  customerId      Int?
  customer        Customer? @relation(fields: [customerId], references: [id])
  saleId          Int?
  sale            Sale?     @relation(fields: [saleId], references: [id])
  
  categoryId      Int?
  category        FinancialCategory? @relation(fields: [categoryId], references: [id])
  
  amount          Decimal   @db.Decimal(25, 2)
  dueDate         DateTime
  receivedDate    DateTime?
  
  status          String    @default("PENDING") // PENDING, PAID, OVERDUE, CANCELLED
  paymentMethod   String?
  
  note            String?   @db.Text
  
  // Relations
  installments    Installment[]
  attachments     Attachment[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("fin_accounts_receivable")
}

model Installment {
  id                  Int       @id @default(autoincrement())
  accountsPayableId   Int?
  accountsPayable     AccountsPayable? @relation(fields: [accountsPayableId], references: [id], onDelete: Cascade)
  
  accountsReceivableId Int?
  accountsReceivable  AccountsReceivable? @relation(fields: [accountsReceivableId], references: [id], onDelete: Cascade)
  
  number              Int       // 1/3, 2/3...
  amount              Decimal   @db.Decimal(25, 2)
  dueDate             DateTime
  paidDate            DateTime?
  status              String    @default("PENDING")
  
  note                String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("fin_installments")
}

model FinancialTransaction {
  id              Int       @id @default(autoincrement())
  description     String
  type            String    // EXPENSE, INCOME, TRANSFER
  amount          Decimal   @db.Decimal(25, 2)
  date            DateTime  @default(now())
  
  categoryId      Int?
  category        FinancialCategory? @relation(fields: [categoryId], references: [id])
  
  bankAccountId   Int?
  bankAccount     BankAccount? @relation(fields: [bankAccountId], references: [id])
  
  paymentMethod   String?
  reference       String?   // internal ref
  
  accountsPayableId    Int?
  accountsReceivableId Int?
  
  attachments     Attachment[]
  
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  
  createdAt       DateTime  @default(now())

  @@map("fin_transactions")
}
